{{ $here           := .RelPermalink }}
{{ $currentSection := .CurrentSection }}

<div class="nav is-sticky">
  {{ range site.Sections }}
  {{ $children := .RegularPages -}}
  {{ if eq .Params.nav_children "none" -}}
    {{ $children = false -}}
  {{ else if hasPrefix .Params.nav_children "section" -}}
    {{ $children = .Sections -}}
  {{ end -}}
  {{ $isThisSection := hasPrefix $currentSection.RelPermalink .CurrentSection.RelPermalink }}
  <div class="nav-section" x-data="{ open: {{ $isThisSection }} }">
    {{ $isHere := eq $here .RelPermalink -}}
    {{ $title := .Params.short | default .Title -}}
    <nav class="level">
      <div class="level-left">
        <a class="nav-section-title is-size-5 is-size-6-mobile{{ if $isHere }} is-active{{ end }}" href="{{ .RelPermalink }}">
          {{ $title }}
        </a>
      </div>

      {{ if $children }}
      <div class="level-right">
        <span class="level-item" @click="open = !open">
          <i class="fas has-text-grey" :class="{ 'fa-chevron-down': !open, 'fa-chevron-up': open }"></i>
        </span>
      </div>
      {{ end }}
    </nav>

    {{ with $children }}
    <ul class="nav-section-links" x-show="open">
      {{ range . }}
      {{ $isHere := eq $here .RelPermalink }}
      {{ $title := .Params.short | default .Title -}}
      <li class="nav-section-link{{ if $isHere }} is-active{{ end }}">
        <a href="{{ .RelPermalink }}">
          {{ $title }}
        </a>
      </li>

      {{ if $isHere }}
      {{ if false }}
      <div class="nav-section-toc">
        {{ .TableOfContents }}
      </div>
      {{ end }}
      {{ end }}
      {{ end }}
    </ul>
    {{ end }}
  </div>
  {{ end }}
</div>
